<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>Designing Robust Build Systems ← Machinae Elegantiam</title>
	<meta name="author" content="Russell Harmon"/>

	

	<link rel="stylesheet" href="/css/reset.css" type="text/css"/>
	<link rel="stylesheet" href="/css/screen.css" type="text/css"/>
	<link rel="stylesheet" href="/css/960.css" type="text/css"/>
	<link rel="stylesheet" href="/css/syntax.css" type="text/css"/>

	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Walter+Turncoat:regular"/>

	

	

	

	

	
	<meta name="keywords" content="machinae"/>
	

	<meta name="description" content="A correct build system must be able to solve the problem of traversal-time dependency detection."/>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
	<script type="text/javascript" src="https://raw.github.com/gabrielfalcao/jquery-yql/master/jquery.yql.js"></script>
	<script type="text/javascript" src="https://raw.github.com/rmm5t/jquery-timeago/master/jquery.timeago.js"></script>

	
	
</head>
<body id="">
	<div id="site">
		<div id="header">
	<h1>
		<span class="nav">
			<a href="/machinae" title="A programming blog">Machinae Elegantiam</a>
			<span class="byline">← <a href="/">Russell Harmon</a></span>
		</span>
	</h1>
</div>
<div id="page"><p>A few years ago, I took a hard look at the current state of the art of build systems. The ones I looked at were the ones that I had heard of, specifically <a href='http://dev/null'><abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr></a>, <a href='http://dev/null'>SCons</a>, <a href='http://dev/null'>C<abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr></a>, <a href='http://dev/null'>Jam</a>, TODO. I slowly came to the realization every build system designer since the creators of <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> (which arguably does it right) have been thinking about building software all wrong.</p>

<p>Understand that the entire purpose of a build system is to compile your complex piece of software <em>correctly every time</em>. Peter Miller discusses the importance of a correct build system in his paper <a href='http://aegis.sourceforge.net/auug97.pdf'>Recursive <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> Considered Harmful</a>. In order to build correctly always, the system must fully understand the <em>dependency tree</em> of the software. This dependency tree is, composed in part by any <code>#include</code> directives in your C files. For example, lets say we&#8217;re making a simple game, with a dependency tree like the following:</p>
<!-- TODO: Don't use <center> --><center>
<!-- Generated by graphviz version 2.26.3 (20100126.1600)
 -->
<!-- Title: example1 Pages: 1 -->
<svg height='98pt' viewBox='0.00 0.00 408.00 98.00' xmlns:xlink='http://www.w3.org/1999/xlink' width='408pt' xmlns='http://www.w3.org/2000/svg'>
<g transform='scale(1 1) rotate(0) translate(4 94)' class='graph' id='graph1'>
<title>example1</title>
<polygon stroke='white' fill='white' points='-4,5 -4,-94 405,-94 405,5 -4,5' />
<!-- common_h -->
<g class='node' id='node1'><title>common_h</title>
<ellipse cy='-72' stroke='black' fill='none' rx='61.1496' ry='18' cx='61' />
<text text-anchor='middle' x='61' font-size='14.00' y='-67.9' font-family='Times Roman,serif'>common.h</text>
</g>
<!-- game_c -->
<g class='node' id='node3'><title>game_c</title>
<ellipse cy='-45' stroke='black' fill='none' rx='45.1673' ry='18' cx='203' />
<text text-anchor='middle' x='203' font-size='14.00' y='-40.9' font-family='Times Roman,serif'>game.c</text>
</g>
<!-- common_h&#45;&gt;game_c -->
<g class='edge' id='edge2'><title>common_h&#45;&gt;game_c</title>
<path stroke='black' d='M112.667,-62.176C125.557,-59.7251 139.367,-57.0992 152.214,-54.6565' fill='none' />
<polygon stroke='black' fill='black' points='153.104,-58.05 162.274,-52.7436 151.797,-51.1732 153.104,-58.05' />
</g>
<!-- player_h -->
<g class='node' id='node2'><title>player_h</title>
<ellipse cy='-18' stroke='black' fill='none' rx='48.8383' ry='18' cx='61' />
<text text-anchor='middle' x='61' font-size='14.00' y='-13.9' font-family='Times Roman,serif'>player.h</text>
</g>
<!-- player_h&#45;&gt;game_c -->
<g class='edge' id='edge4'><title>player_h&#45;&gt;game_c</title>
<path stroke='black' d='M105.151,-26.395C120.111,-29.2395 136.936,-32.4386 152.361,-35.3714' fill='none' />
<polygon stroke='black' fill='black' points='151.783,-38.8242 162.261,-37.2538 153.091,-31.9474 151.783,-38.8242' />
</g>
<!-- game_exe -->
<g class='node' id='node4'><title>game_exe</title>
<ellipse cy='-45' stroke='black' fill='none' rx='57.1737' ry='18' cx='342' />
<text text-anchor='middle' x='342' font-size='14.00' y='-40.9' font-family='Times Roman,serif'>game.exe</text>
</g>
<!-- game_c&#45;&gt;game_exe -->
<g class='edge' id='edge6'><title>game_c&#45;&gt;game_exe</title>
<path stroke='black' d='M248.129,-45C256.538,-45 265.492,-45 274.404,-45' fill='none' />
<polygon stroke='black' fill='black' points='274.418,-48.5001 284.418,-45 274.418,-41.5001 274.418,-48.5001' />
</g>
</g>
</svg>

</center>
<p>This means that before <code>game.c</code> can be built, <code>common.h</code> and <code>player.h</code> must exist, and before <code>game.exe</code> can be built, <code>game.c</code> must exist. Additionally, <code>game.exe</code> can be said to <em>transitively depend</em> upon <code>common.h</code> and <code>player.h</code>.</p>

<p>Now, this works fine always because you wrote <code>common.h</code>, <code>player.h</code> and <code>game.c</code>, but lets say you were writing a game, and wanted to create a domain-specific language to express the levels. This <abbr title='Domain specific language'>DSL</abbr>&#8217;s compiler would output C code, which would then be used from within your code. This can be expressed like so:</p>
<center>
<!-- Generated by graphviz version 2.26.3 (20100126.1600)
 -->
<!-- Title: example2 Pages: 1 -->
<svg height='332pt' viewBox='0.00 0.00 359.61 332.00' xmlns:xlink='http://www.w3.org/1999/xlink' width='360pt' xmlns='http://www.w3.org/2000/svg'>
<g transform='scale(1 1) rotate(0) translate(4 328)' class='graph' id='graph1'>
<title>example2</title>
<polygon stroke='white' fill='white' points='-4,5 -4,-328 356.614,-328 356.614,5 -4,5' />
<!-- common_h -->
<g class='node' id='node1'><title>common_h</title>
<ellipse cy='-306' stroke='black' fill='none' rx='61.1496' ry='18' cx='228.629' />
<text text-anchor='middle' x='228.629' font-size='14.00' y='-301.9' font-family='Times Roman,serif'>common.h</text>
</g>
<!-- game_c -->
<g class='node' id='node3'><title>game_c</title>
<ellipse cy='-90' stroke='black' fill='none' rx='45.1673' ry='18' cx='63.6286' />
<text text-anchor='middle' x='63.6286' font-size='14.00' y='-85.9' font-family='Times Roman,serif'>game.c</text>
</g>
<!-- common_h&#45;&gt;game_c -->
<g class='edge' id='edge12'><title>common_h&#45;&gt;game_c</title>
<path stroke='black' d='M181.041,-294.443C127.553,-278.623 43.2819,-244.523 5.62861,-180 -2.43571,-166.181 -0.757193,-158.67 5.62861,-144 11.0879,-131.458 21.0548,-120.513 31.2047,-111.816' fill='none' />
<polygon stroke='black' fill='black' points='33.6811,-114.318 39.3014,-105.336 29.307,-108.852 33.6811,-114.318' />
</g>
<!-- levcomp_c -->
<g class='node' id='node5'><title>levcomp_c</title>
<ellipse cy='-234' stroke='black' fill='none' rx='86.1654' ry='18' cx='228.629' />
<text text-anchor='middle' x='228.629' font-size='14.00' y='-229.9' font-family='Times Roman,serif'>level_compiler.c</text>
</g>
<!-- common_h&#45;&gt;levcomp_c -->
<g class='edge' id='edge2'><title>common_h&#45;&gt;levcomp_c</title>
<path stroke='black' d='M228.629,-287.831C228.629,-280.131 228.629,-270.974 228.629,-262.417' fill='none' />
<polygon stroke='black' fill='black' points='232.129,-262.413 228.629,-252.413 225.129,-262.413 232.129,-262.413' />
</g>
<!-- levels_c -->
<g class='node' id='node7'><title>levels_c</title>
<ellipse cy='-90' stroke='black' fill='none' rx='46.0565' ry='18' cx='200.629' />
<text text-anchor='middle' x='200.629' font-size='14.00' y='-85.9' font-family='Times Roman,serif'>levels.c</text>
</g>
<!-- common_h&#45;&gt;levels_c -->
<g class='edge' id='edge8'><title>common_h&#45;&gt;levels_c</title>
<path stroke='black' d='M269.058,-292.49C288.545,-283.915 310.487,-270.821 323.629,-252 351.277,-212.402 362.704,-183.992 335.629,-144 317.652,-117.448 284.278,-103.951 255.212,-97.0903' fill='none' stroke-dasharray='5,2' />
<polygon stroke='black' fill='black' points='255.655,-93.6057 245.143,-94.9298 254.187,-100.45 255.655,-93.6057' />
</g>
<!-- player_h -->
<g class='node' id='node2'><title>player_h</title>
<ellipse cy='-162' stroke='black' fill='none' rx='48.8383' ry='18' cx='63.6286' />
<text text-anchor='middle' x='63.6286' font-size='14.00' y='-157.9' font-family='Times Roman,serif'>player.h</text>
</g>
<!-- player_h&#45;&gt;game_c -->
<g class='edge' id='edge14'><title>player_h&#45;&gt;game_c</title>
<path stroke='black' d='M63.6286,-143.831C63.6286,-136.131 63.6286,-126.974 63.6286,-118.417' fill='none' />
<polygon stroke='black' fill='black' points='67.1287,-118.413 63.6286,-108.413 60.1287,-118.413 67.1287,-118.413' />
</g>
<!-- player_h&#45;&gt;levels_c -->
<g class='edge' id='edge6'><title>player_h&#45;&gt;levels_c</title>
<path stroke='black' d='M92.0151,-147.082C112.818,-136.149 141.243,-121.21 163.795,-109.358' fill='none' stroke-dasharray='5,2' />
<polygon stroke='black' fill='black' points='165.523,-112.403 172.747,-104.653 162.267,-106.207 165.523,-112.403' />
</g>
<!-- game_exe -->
<g class='node' id='node4'><title>game_exe</title>
<ellipse cy='-18' stroke='black' fill='none' rx='57.1737' ry='18' cx='131.629' />
<text text-anchor='middle' x='131.629' font-size='14.00' y='-13.9' font-family='Times Roman,serif'>game.exe</text>
</g>
<!-- game_c&#45;&gt;game_exe -->
<g class='edge' id='edge16'><title>game_c&#45;&gt;game_exe</title>
<path stroke='black' d='M79.7437,-72.937C88.2564,-63.9235 98.8602,-52.6959 108.259,-42.7443' fill='none' />
<polygon stroke='black' fill='black' points='110.835,-45.114 115.157,-35.4407 105.746,-40.3076 110.835,-45.114' />
</g>
<!-- levcomp -->
<g class='node' id='node6'><title>levcomp</title>
<ellipse cy='-162' stroke='black' fill='none' rx='97.9784' ry='18' cx='228.629' />
<text text-anchor='middle' x='228.629' font-size='14.00' y='-157.9' font-family='Times Roman,serif'>level_compiler.exe</text>
</g>
<!-- levcomp_c&#45;&gt;levcomp -->
<g class='edge' id='edge3'><title>levcomp_c&#45;&gt;levcomp</title>
<path stroke='black' d='M228.629,-215.831C228.629,-208.131 228.629,-198.974 228.629,-190.417' fill='none' />
<polygon stroke='black' fill='black' points='232.129,-190.413 228.629,-180.413 225.129,-190.413 232.129,-190.413' />
</g>
<!-- levcomp&#45;&gt;levels_c -->
<g class='edge' id='edge4'><title>levcomp&#45;&gt;levels_c</title>
<path stroke='black' d='M221.563,-143.831C218.456,-135.841 214.738,-126.282 211.304,-117.451' fill='none' />
<polygon stroke='black' fill='black' points='214.481,-115.965 207.595,-107.913 207.957,-118.502 214.481,-115.965' />
</g>
<!-- levels_c&#45;&gt;game_exe -->
<g class='edge' id='edge10'><title>levels_c&#45;&gt;game_exe</title>
<path stroke='black' d='M184.277,-72.937C175.639,-63.9235 164.879,-52.6959 155.342,-42.7443' fill='none' />
<polygon stroke='black' fill='black' points='157.789,-40.2389 148.343,-35.4407 152.735,-45.0823 157.789,-40.2389' />
</g>
</g>
</svg>

</center>
<p>The dependencies <code>common.h → levels.c</code> and <code>player.h → levels.c</code> is not detected in this case unless you explicitly write that dependency into your build system. That is undesirable however as doing so is fragile. What you really want, is to <em>dynamically</em> introduce dependencies into the build system. In other words, in order for a build system to be <em>correct</em>, it sometimes must be able to detect dependencies while it&#8217;s traversing the dependency tree it is detecting dependencies for!</p>

<p><abbr title='GNU Compiler Collection'>GCC</abbr> provides a facility for outputting a <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> compatible list of a file&#8217;s dependencies with the <code>-M</code> option. From <abbr title='GNU Compiler Collection'>GCC</abbr>&#8217;s <a href='http://gcc.gnu.org/onlinedocs/cpp/Invocation.html#index-M-141'>docs</a>:</p>

<pre><code>-M
	Instead of outputting the result of preprocessing, output a rule
	suitable for make describing the dependencies of the main source file.</code></pre>

<p>GNU <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> has introduced the <code>include</code> extension that allows you to generate and include these files, albeit in a more limited fashion. From the <a href='http://www.gnu.org/software/make/manual/html_node/Remaking-Makefiles.html#Remaking-Makefiles'>include</a> directive&#8217;s documentation:</p>

<pre><code>After reading in all makefiles, make will consider each as a goal target and
attempt to update it. If a makefile has a rule which says how to update it
(found either in that very makefile or in another one) or if an implicit
rule applies to it (see Using Implicit Rules), it will be updated if
necessary. After all makefiles have been checked, if any have actually been
changed, make starts with a clean slate and reads all the makefiles over
again.</code></pre>

<p>This mechanism can be leveraged to create a limited solution to the <em>traversal-time dependency detection</em> problem, which our game suffered from. Unfortunately, this works only for a single &#8220;level&#8221; of traversal-time dependency detection. E.g. the following does not work:</p>
<center>
<!-- Generated by graphviz version 2.26.3 (20100126.1600)
 -->
<!-- Title: example3 Pages: 1 -->
<svg height='404pt' viewBox='0.00 0.00 154.00 404.00' xmlns:xlink='http://www.w3.org/1999/xlink' width='154pt' xmlns='http://www.w3.org/2000/svg'>
<g transform='scale(1 1) rotate(0) translate(4 400)' class='graph' id='graph1'>
<title>example3</title>
<polygon stroke='white' fill='white' points='-4,5 -4,-400 151,-400 151,5 -4,5' />
<!-- a_c -->
<g class='node' id='node1'><title>a_c</title>
<ellipse cy='-378' stroke='black' fill='none' rx='27' ry='18' cx='37' />
<text text-anchor='middle' x='37' font-size='14.00' y='-373.9' font-family='Times Roman,serif'>a.c</text>
</g>
<!-- a_exe -->
<g class='node' id='node2'><title>a_exe</title>
<ellipse cy='-306' stroke='black' fill='none' rx='36.8288' ry='18' cx='37' />
<text text-anchor='middle' x='37' font-size='14.00' y='-301.9' font-family='Times Roman,serif'>a.exe</text>
</g>
<!-- a_c&#45;&gt;a_exe -->
<g class='edge' id='edge2'><title>a_c&#45;&gt;a_exe</title>
<path stroke='black' d='M37,-359.831C37,-352.131 37,-342.974 37,-334.417' fill='none' />
<polygon stroke='black' fill='black' points='40.5001,-334.413 37,-324.413 33.5001,-334.413 40.5001,-334.413' />
</g>
<!-- b_c -->
<g class='node' id='node3'><title>b_c</title>
<ellipse cy='-234' stroke='black' fill='none' rx='27' ry='18' cx='37' />
<text text-anchor='middle' x='37' font-size='14.00' y='-229.9' font-family='Times Roman,serif'>b.c</text>
</g>
<!-- a_exe&#45;&gt;b_c -->
<g class='edge' id='edge3'><title>a_exe&#45;&gt;b_c</title>
<path stroke='black' d='M37,-287.831C37,-280.131 37,-270.974 37,-262.417' fill='none' />
<polygon stroke='black' fill='black' points='40.5001,-262.413 37,-252.413 33.5001,-262.413 40.5001,-262.413' />
</g>
<!-- b_exe -->
<g class='node' id='node4'><title>b_exe</title>
<ellipse cy='-162' stroke='black' fill='none' rx='36.8288' ry='18' cx='37' />
<text text-anchor='middle' x='37' font-size='14.00' y='-157.9' font-family='Times Roman,serif'>b.exe</text>
</g>
<!-- b_c&#45;&gt;b_exe -->
<g class='edge' id='edge4'><title>b_c&#45;&gt;b_exe</title>
<path stroke='black' d='M37,-215.831C37,-208.131 37,-198.974 37,-190.417' fill='none' />
<polygon stroke='black' fill='black' points='40.5001,-190.413 37,-180.413 33.5001,-190.413 40.5001,-190.413' />
</g>
<!-- c_c -->
<g class='node' id='node6'><title>c_c</title>
<ellipse cy='-90' stroke='black' fill='none' rx='27' ry='18' cx='78' />
<text text-anchor='middle' x='78' font-size='14.00' y='-85.9' font-family='Times Roman,serif'>c.c</text>
</g>
<!-- b_exe&#45;&gt;c_c -->
<g class='edge' id='edge5'><title>b_exe&#45;&gt;c_c</title>
<path stroke='black' d='M46.925,-144.571C51.81,-135.992 57.7983,-125.476 63.2097,-115.973' fill='none' />
<polygon stroke='black' fill='black' points='66.2595,-117.691 68.1664,-107.269 60.1766,-114.227 66.2595,-117.691' />
</g>
<!-- c_h -->
<g class='node' id='node5'><title>c_h</title>
<ellipse cy='-162' stroke='black' fill='none' rx='27' ry='18' cx='119' />
<text text-anchor='middle' x='119' font-size='14.00' y='-157.9' font-family='Times Roman,serif'>c.h</text>
</g>
<!-- c_h&#45;&gt;c_c -->
<g class='edge' id='edge8'><title>c_h&#45;&gt;c_c</title>
<path stroke='black' d='M109.284,-144.937C104.331,-136.239 98.2039,-125.48 92.6887,-115.795' fill='none' />
<polygon stroke='black' fill='black' points='95.6366,-113.898 87.6467,-106.941 89.5537,-117.362 95.6366,-113.898' />
</g>
<!-- c_exe -->
<g class='node' id='node7'><title>c_exe</title>
<ellipse cy='-18' stroke='black' fill='none' rx='36.1339' ry='18' cx='78' />
<text text-anchor='middle' x='78' font-size='14.00' y='-13.9' font-family='Times Roman,serif'>c.exe</text>
</g>
<!-- c_c&#45;&gt;c_exe -->
<g class='edge' id='edge6'><title>c_c&#45;&gt;c_exe</title>
<path stroke='black' d='M78,-71.8314C78,-64.131 78,-54.9743 78,-46.4166' fill='none' />
<polygon stroke='black' fill='black' points='81.5001,-46.4132 78,-36.4133 74.5001,-46.4133 81.5001,-46.4132' />
</g>
</g>
</svg>

</center>
<p>I&#8217;ve built a functional build system for <abbr title='A single-player roguelike video game originally released in 1987.'>Nethack</abbr> which leverages these concepts. You can see an abbreviated dependency graph for Nethack <a href='/files/nethack-dependencies.pdf'>here</a>, and I also gave a presentation on the <abbr title='A single-player roguelike video game originally released in 1987.'>Nethack</abbr> build system which can be seen <a href='http://prezi.com/vzxavg014qlf/nethack-compilation/'>here</a>. The build system itself is hosted <a href='https://github.com/ComputerScienceHouse/bingehack'>here</a>.</p></div>

<!-- Disqus comment engine -->
<div id="disqus">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		var disqus_shortname = 'eatnumber1';
		
		var disqus_identifier = '/blog/2012-05-18/designing-robust-build-systems';
		
		

		(function() {
			var dsq = document.createElement('script');
			dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] ||
			 document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>
		Please enable JavaScript to view the
		<a href="http://disqus.com/?ref_noscript">
			comments powered by Disqus.
		</a>
	</noscript>
	<a href="http://disqus.com" class="dsq-brlink">
		blog comments powered by
		<span class="logo-disqus">Disqus</span>
	</a>
</div>







		<div id="footer">
			<address>
				<span class="copyright">
					Content by <a rel="author" href="/">Russell Harmon</a>.
					Design by <a href="http://mark.reid.name/info/site.html">Mark Reid</a>
					<br/>
					(<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)
				</span>
				<span class="engine">
					Powered by <a href="http://jekyllrb.com/" title="A static, minimalist CMS">Jekyll</a>.
					Hosted by <a href="http://pages.github.com/">GitHub</a>.
				</span>
			<address>
		</div>
	</div>

	
	<!-- Google Analytics -->
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-10349264-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	
</body>
</html>


