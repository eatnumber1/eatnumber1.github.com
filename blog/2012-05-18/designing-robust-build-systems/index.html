<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>Designing Robust Build Systems ← Machinae Elegantiam</title><meta name="author" content="Russell Harmon"/><link rel="stylesheet" href="/css/reset.css" type="text/css"/><link rel="stylesheet" href="/css/screen.css" type="text/css"/><link rel="stylesheet" href="/css/960.css" type="text/css"/><link rel="stylesheet" href="/css/syntax.css" type="text/css"/><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Walter+Turncoat:regular"/><meta name="keywords" content="programming,build systems,make"/><meta name="description" content="A correct build system must be able to solve the problem of traversal-time dependency detection."/></head><body id=""><div id="site"><div id="header"><h1> <span class="nav"> <a href="/machinae" title="A programming blog">Machinae Elegantiam</a> <span class="byline">← <a href="/">Russell Harmon</a></span> </span></h1></div><div id="page"><p>A few years ago, I took a hard look at the current state of the art of build systems. The ones I looked at were the ones that I had heard of, specifically <a href="http://dev/null"><abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr></a>, <a href="http://dev/null">SCons</a>, <a href="http://dev/null">CMake</a>, <a href="http://dev/null">Jam</a>. I slowly came to the realization every build system designer since the creators of <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> (which arguably does it right) have been thinking about building software all wrong.</p><p>Understand that the entire purpose of a build system is to compile your complex piece of software <em>correctly every time</em>. Peter Miller discusses the importance of a correct build system in his paper <a href="http://aegis.sourceforge.net/auug97.pdf">Recursive <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> Considered Harmful</a>. In order to build correctly always, the system must fully understand the <em>dependency tree</em> of the software. This dependency tree is, composed in part by any <code>#include</code> directives in your C files. For example, lets say we’re making a simple game, with a dependency tree like the following:</p><center><div class="graphviz-wrapper"><svg role="img" aria-label="" width="341pt" height="98pt" viewbox="0.00 0.00 341.28 98.00"><title></title> <desc> digraph example1 { rankdir = "LR";common_h [label = "common.h"]; player_h [label = "player.h"]; game_c [label = "game.c"]; game_exe [label = "game.exe"];common_h -&gt; game_c; player_h -&gt; game_c; game_c -&gt; game_exe; } </desc><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)"><title>example1</title> <polygon fill="white" stroke="none" points="-4,4 -4,-94 337.277,-94 337.277,4 -4,4"/><g id="node1" class="node"><title>common_h</title> <ellipse fill="none" stroke="black" cx="49.3956" cy="-72" rx="49.2915" ry="18"/> <text text-anchor="middle" x="49.3956" y="-68.3" font-family="Times,serif" font-size="14.00">common.h</text> </g><g id="node3" class="node"><title>game_c</title> <ellipse fill="none" stroke="black" cx="171.188" cy="-45" rx="36.2938" ry="18"/> <text text-anchor="middle" x="171.188" y="-41.3" font-family="Times,serif" font-size="14.00">game.c</text> </g><g id="edge1" class="edge"><title>common_h-&gt;game_c</title> <path fill="none" stroke="black" d="M91.957,-62.6325C103.56,-60.0173 116.179,-57.1731 127.827,-54.5476"/> <polygon fill="black" stroke="black" points="128.779,-57.9211 137.764,-52.308 127.239,-51.0924 128.779,-57.9211"/> </g><g id="node2" class="node"><title>player_h</title> <ellipse fill="none" stroke="black" cx="49.3956" cy="-18" rx="39.7935" ry="18"/> <text text-anchor="middle" x="49.3956" y="-14.3" font-family="Times,serif" font-size="14.00">player.h</text> </g><g id="edge2" class="edge"><title>player_h-&gt;game_c</title> <path fill="none" stroke="black" d="M85.3666,-25.8821C98.7036,-28.8881 114.048,-32.3465 127.987,-35.4882"/> <polygon fill="black" stroke="black" points="127.315,-38.9245 137.84,-37.709 128.854,-32.0958 127.315,-38.9245"/> </g><g id="node4" class="node"><title>game_exe</title> <ellipse fill="none" stroke="black" cx="288.431" cy="-45" rx="44.6926" ry="18"/> <text text-anchor="middle" x="288.431" y="-41.3" font-family="Times,serif" font-size="14.00">game.exe</text> </g><g id="edge3" class="edge"><title>game_c-&gt;game_exe</title> <path fill="none" stroke="black" d="M207.705,-45C215.786,-45 224.55,-45 233.212,-45"/> <polygon fill="black" stroke="black" points="233.286,-48.5001 243.286,-45 233.286,-41.5001 233.286,-48.5001"/> </g> </g> </svg></div></center><p>This means that before <code>game.c</code> can be built, <code>common.h</code> and <code>player.h</code> must exist, and before <code>game.exe</code> can be built, <code>game.c</code> must exist. Additionally, <code>game.exe</code> can be said to <em>transitively depend</em> upon <code>common.h</code> and <code>player.h</code>.</p><p>Now, this works fine always because you wrote <code>common.h</code>, <code>player.h</code> and <code>game.c</code>, but lets say you were writing a game, and wanted to create a domain-specific language to express the levels. This <abbr title="Domain specific language">DSL</abbr>’s compiler would output C code, which would then be used from within your code. This can be expressed like so:</p><center><div class="graphviz-wrapper"><svg role="img" aria-label="" width="302pt" height="332pt" viewbox="0.00 0.00 301.93 332.00"><title></title> <desc> digraph example2 { common_h [label = "common.h"]; player_h [label = "player.h"]; game_c [label = "game.c"]; game_exe [label = "game.exe"];levcomp_c [label = "level_compiler.c"]; levcomp [label = "level_compiler.exe"]; levels_c [label = "levels.c"];common_h -&gt; levcomp_c -&gt; levcomp -&gt; levels_c; player_h -&gt; levels_c [style = "dashed"]; common_h -&gt; levels_c [style = "dashed"]; levels_c -&gt; game_exe;common_h -&gt; game_c; player_h -&gt; game_c; game_c -&gt; game_exe; } </desc><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)"><title>example2</title> <polygon fill="white" stroke="none" points="-4,4 -4,-328 297.932,-328 297.932,4 -4,4"/><g id="node1" class="node"><title>common_h</title> <ellipse fill="none" stroke="black" cx="190.202" cy="-306" rx="49.2915" ry="18"/> <text text-anchor="middle" x="190.202" y="-302.3" font-family="Times,serif" font-size="14.00">common.h</text> </g><g id="node3" class="node"><title>game_c</title> <ellipse fill="none" stroke="black" cx="54.2023" cy="-90" rx="36.2938" ry="18"/> <text text-anchor="middle" x="54.2023" y="-86.3" font-family="Times,serif" font-size="14.00">game.c</text> </g><g id="edge7" class="edge"><title>common_h-&gt;game_c</title> <path fill="none" stroke="black" d="M155.135,-293.087C110.891,-275.93 36.7698,-239.603 5.20232,-180 -2.28627,-165.861 -0.629766,-158.899 5.20232,-144 9.91278,-131.966 18.7796,-121.027 27.6898,-112.253"/> <polygon fill="black" stroke="black" points="30.1216,-114.772 35.0942,-105.416 25.3728,-109.629 30.1216,-114.772"/> </g><g id="node5" class="node"><title>levcomp_c</title> <ellipse fill="none" stroke="black" cx="190.202" cy="-234" rx="70.3881" ry="18"/> <text text-anchor="middle" x="190.202" y="-230.3" font-family="Times,serif" font-size="14.00">level_compiler.c</text> </g><g id="edge1" class="edge"><title>common_h-&gt;levcomp_c</title> <path fill="none" stroke="black" d="M190.202,-287.697C190.202,-279.983 190.202,-270.712 190.202,-262.112"/> <polygon fill="black" stroke="black" points="193.702,-262.104 190.202,-252.104 186.702,-262.104 193.702,-262.104"/> </g><g id="node7" class="node"><title>levels_c</title> <ellipse fill="none" stroke="black" cx="168.202" cy="-90" rx="37.8943" ry="18"/> <text text-anchor="middle" x="168.202" y="-86.3" font-family="Times,serif" font-size="14.00">levels.c</text> </g><g id="edge5" class="edge"><title>common_h-&gt;levels_c</title> <path fill="none" stroke="black" stroke-dasharray="5,2" d="M221.386,-291.999C238.364,-283.249 258.114,-269.999 269.202,-252 294.465,-210.99 303.824,-184.786 278.202,-144 263.732,-120.966 236.131,-107.707 212.198,-100.212"/> <polygon fill="black" stroke="black" points="213.136,-96.8397 202.558,-97.4309 211.196,-103.565 213.136,-96.8397"/> </g><g id="node2" class="node"><title>player_h</title> <ellipse fill="none" stroke="black" cx="54.2023" cy="-162" rx="39.7935" ry="18"/> <text text-anchor="middle" x="54.2023" y="-158.3" font-family="Times,serif" font-size="14.00">player.h</text> </g><g id="edge8" class="edge"><title>player_h-&gt;game_c</title> <path fill="none" stroke="black" d="M54.2023,-143.697C54.2023,-135.983 54.2023,-126.712 54.2023,-118.112"/> <polygon fill="black" stroke="black" points="57.7024,-118.104 54.2023,-108.104 50.7024,-118.104 57.7024,-118.104"/> </g><g id="edge4" class="edge"><title>player_h-&gt;levels_c</title> <path fill="none" stroke="black" stroke-dasharray="5,2" d="M76.725,-147.17C93.9784,-136.576 117.982,-121.837 137.072,-110.115"/> <polygon fill="black" stroke="black" points="139.036,-113.016 145.726,-104.801 135.373,-107.051 139.036,-113.016"/> </g><g id="node4" class="node"><title>game_exe</title> <ellipse fill="none" stroke="black" cx="111.202" cy="-18" rx="44.6926" ry="18"/> <text text-anchor="middle" x="111.202" y="-14.3" font-family="Times,serif" font-size="14.00">game.exe</text> </g><g id="edge9" class="edge"><title>game_c-&gt;game_exe</title> <path fill="none" stroke="black" d="M67.1365,-73.1159C74.3217,-64.292 83.4109,-53.1298 91.4656,-43.238"/> <polygon fill="black" stroke="black" points="94.3235,-45.2714 97.9238,-35.307 88.8954,-40.8514 94.3235,-45.2714"/> </g><g id="node6" class="node"><title>levcomp</title> <ellipse fill="none" stroke="black" cx="190.202" cy="-162" rx="78.7863" ry="18"/> <text text-anchor="middle" x="190.202" y="-158.3" font-family="Times,serif" font-size="14.00">level_compiler.exe</text> </g><g id="edge2" class="edge"><title>levcomp_c-&gt;levcomp</title> <path fill="none" stroke="black" d="M190.202,-215.697C190.202,-207.983 190.202,-198.712 190.202,-190.112"/> <polygon fill="black" stroke="black" points="193.702,-190.104 190.202,-180.104 186.702,-190.104 193.702,-190.104"/> </g><g id="edge3" class="edge"><title>levcomp-&gt;levels_c</title> <path fill="none" stroke="black" d="M184.764,-143.697C182.313,-135.898 179.362,-126.509 176.634,-117.829"/> <polygon fill="black" stroke="black" points="179.915,-116.595 173.578,-108.104 173.237,-118.694 179.915,-116.595"/> </g><g id="edge6" class="edge"><title>levels_c-&gt;game_exe</title> <path fill="none" stroke="black" d="M154.982,-72.7646C147.891,-64.056 139.007,-53.1467 131.099,-43.435"/> <polygon fill="black" stroke="black" points="133.775,-41.1778 124.747,-35.6334 128.347,-45.5978 133.775,-41.1778"/> </g> </g> </svg></div></center><p>The dependencies <code>common.h → levels.c</code> and <code>player.h → levels.c</code> is not detected in this case unless you explicitly write that dependency into your build system. That is undesirable however as doing so is fragile. What you really want, is to <em>dynamically</em> introduce dependencies into the build system. In other words, in order for a build system to be <em>correct</em>, it sometimes must be able to detect dependencies while it’s traversing the dependency tree it is detecting dependencies for!</p><p><abbr title="GNU Compiler Collection">GCC</abbr> provides a facility for outputting a <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> compatible list of a file’s dependencies with the <code>-M</code> option. From <abbr title="GNU Compiler Collection">GCC</abbr>’s <a href="http://gcc.gnu.org/onlinedocs/cpp/Invocation.html#index-M-141">docs</a>:</p><pre><code>-M
	Instead of outputting the result of preprocessing, output a rule
	suitable for make describing the dependencies of the main source file.
</code></pre><p>GNU <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> has introduced the <code>include</code> extension that allows you to generate and include these files, albeit in a more limited fashion. From the <a href="http://www.gnu.org/software/make/manual/html_node/Remaking-Makefiles.html#Remaking-Makefiles">include</a> directive’s documentation:</p><pre><code>After reading in all makefiles, make will consider each as a goal target and
attempt to update it. If a makefile has a rule which says how to update it
(found either in that very makefile or in another one) or if an implicit
rule applies to it (see Using Implicit Rules), it will be updated if
necessary. After all makefiles have been checked, if any have actually been
changed, make starts with a clean slate and reads all the makefiles over
again.
</code></pre><p>This mechanism can be leveraged to create a limited solution to the <em>traversal-time dependency detection</em> problem, which our game suffered from. Unfortunately, this works only for a single “level” of traversal-time dependency detection. E.g. the following does not work:</p><center><div class="graphviz-wrapper"><svg role="img" aria-label="" width="140pt" height="404pt" viewbox="0.00 0.00 139.90 404.00"><title></title> <desc> digraph example3 { //rankdir = "LR";a_c [label = "a.c"]; a_exe [label = "a.exe"]; b_c [label = "b.c"]; b_exe [label = "b.exe"];c_h [label = "c.h"]; c_c [label = "c.c"]; c_exe [label = "c.exe"];a_c -&gt; a_exe -&gt; b_c -&gt; b_exe -&gt; c_c -&gt; c_exe; c_h -&gt; c_c; } </desc><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 400)"><title>example3</title> <polygon fill="white" stroke="none" points="-4,4 -4,-400 135.897,-400 135.897,4 -4,4"/><g id="node1" class="node"><title>a_c</title> <ellipse fill="none" stroke="black" cx="29.8973" cy="-378" rx="27" ry="18"/> <text text-anchor="middle" x="29.8973" y="-374.3" font-family="Times,serif" font-size="14.00">a.c</text> </g><g id="node2" class="node"><title>a_exe</title> <ellipse fill="none" stroke="black" cx="29.8973" cy="-306" rx="29.4969" ry="18"/> <text text-anchor="middle" x="29.8973" y="-302.3" font-family="Times,serif" font-size="14.00">a.exe</text> </g><g id="edge1" class="edge"><title>a_c-&gt;a_exe</title> <path fill="none" stroke="black" d="M29.8973,-359.697C29.8973,-351.983 29.8973,-342.712 29.8973,-334.112"/> <polygon fill="black" stroke="black" points="33.3974,-334.104 29.8973,-324.104 26.3974,-334.104 33.3974,-334.104"/> </g><g id="node3" class="node"><title>b_c</title> <ellipse fill="none" stroke="black" cx="29.8973" cy="-234" rx="27" ry="18"/> <text text-anchor="middle" x="29.8973" y="-230.3" font-family="Times,serif" font-size="14.00">b.c</text> </g><g id="edge2" class="edge"><title>a_exe-&gt;b_c</title> <path fill="none" stroke="black" d="M29.8973,-287.697C29.8973,-279.983 29.8973,-270.712 29.8973,-262.112"/> <polygon fill="black" stroke="black" points="33.3974,-262.104 29.8973,-252.104 26.3974,-262.104 33.3974,-262.104"/> </g><g id="node4" class="node"><title>b_exe</title> <ellipse fill="none" stroke="black" cx="29.8973" cy="-162" rx="29.795" ry="18"/> <text text-anchor="middle" x="29.8973" y="-158.3" font-family="Times,serif" font-size="14.00">b.exe</text> </g><g id="edge3" class="edge"><title>b_c-&gt;b_exe</title> <path fill="none" stroke="black" d="M29.8973,-215.697C29.8973,-207.983 29.8973,-198.712 29.8973,-190.112"/> <polygon fill="black" stroke="black" points="33.3974,-190.104 29.8973,-180.104 26.3974,-190.104 33.3974,-190.104"/> </g><g id="node6" class="node"><title>c_c</title> <ellipse fill="none" stroke="black" cx="66.8973" cy="-90" rx="27" ry="18"/> <text text-anchor="middle" x="66.8973" y="-86.3" font-family="Times,serif" font-size="14.00">c.c</text> </g><g id="edge4" class="edge"><title>b_exe-&gt;c_c</title> <path fill="none" stroke="black" d="M38.6658,-144.411C43.0894,-136.042 48.5507,-125.71 53.4876,-116.37"/> <polygon fill="black" stroke="black" points="56.613,-117.947 58.1918,-107.47 50.4243,-114.675 56.613,-117.947"/> </g><g id="node5" class="node"><title>c_h</title> <ellipse fill="none" stroke="black" cx="104.897" cy="-162" rx="27" ry="18"/> <text text-anchor="middle" x="104.897" y="-158.3" font-family="Times,serif" font-size="14.00">c.h</text> </g><g id="edge6" class="edge"><title>c_h-&gt;c_c</title> <path fill="none" stroke="black" d="M96.0839,-144.765C91.4796,-136.283 85.7423,-125.714 80.576,-116.197"/> <polygon fill="black" stroke="black" points="83.51,-114.266 75.663,-107.147 77.358,-117.606 83.51,-114.266"/> </g><g id="node7" class="node"><title>c_exe</title> <ellipse fill="none" stroke="black" cx="66.8973" cy="-18" rx="29.4969" ry="18"/> <text text-anchor="middle" x="66.8973" y="-14.3" font-family="Times,serif" font-size="14.00">c.exe</text> </g><g id="edge5" class="edge"><title>c_c-&gt;c_exe</title> <path fill="none" stroke="black" d="M66.8973,-71.6966C66.8973,-63.9827 66.8973,-54.7125 66.8973,-46.1124"/> <polygon fill="black" stroke="black" points="70.3974,-46.1043 66.8973,-36.1043 63.3974,-46.1044 70.3974,-46.1043"/> </g> </g> </svg></div></center><p>I’ve built a functional build system for <abbr title="A single-player roguelike video game originally released in 1987.">Nethack</abbr> which leverages these concepts. You can see an abbreviated dependency graph for <abbr title="A single-player roguelike video game originally released in 1987.">Nethack</abbr> <a href="/files/nethack-dependencies.pdf">here</a>, and I also gave a presentation on the <abbr title="A single-player roguelike video game originally released in 1987.">Nethack</abbr> build system which can be seen <a href="http://prezi.com/vzxavg014qlf/nethack-compilation/">here</a>. The build system itself is hosted <a href="https://github.com/ComputerScienceHouse/bingehack">here</a>.</p></div><div id="disqus"><div id="disqus_thread"></div> <script>var disqus_shortname="eatnumber1",disqus_identifier="/blog/2012-05-18/designing-robust-build-systems";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript> Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript"> comments powered by Disqus. </a> </noscript> <a href="http://disqus.com" class="dsq-brlink"> blog comments powered by <span class="logo-disqus">Disqus</span> </a></div><div id="footer"> <address> <span class="copyright"> Content by <a rel="author" href="/">Russell Harmon</a>. Design by <a href="http://mark.reid.name/info/site.html">Mark Reid</a> <br/> (<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>) </span> <span class="engine"> Powered by <a href="http://jekyllrb.com/" title="A static, minimalist CMS">Jekyll</a>. Hosted by <a href="http://pages.github.com/">GitHub</a>. </span> <address></div></div> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-10349264-2"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html>