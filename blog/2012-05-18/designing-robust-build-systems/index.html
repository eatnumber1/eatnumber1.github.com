<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>Designing Robust Build Systems ← Machinae Elegantiam</title><meta name="author" content="Russell Harmon"/><link rel="stylesheet" href="/css/reset.css" type="text/css"/><link rel="stylesheet" href="/css/screen.css" type="text/css"/><link rel="stylesheet" href="/css/960.css" type="text/css"/><link rel="stylesheet" href="/css/syntax.css" type="text/css"/><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Walter+Turncoat:regular"/><meta name="keywords" content="machinae"/><meta name="description" content="A correct build system must be able to solve the problem of traversal-time dependency detection."/><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script><script src="/js/jquery.yql.js"></script><script src="/js/jquery.timeago.js"></script></head><body id=""><div id="site"><div id="header"><h1> <span class="nav"> <a href="/machinae" title="A programming blog">Machinae Elegantiam</a> <span class="byline">← <a href="/">Russell Harmon</a></span> </span></h1></div><div id="page"><p>A few years ago, I took a hard look at the current state of the art of build systems. The ones I looked at were the ones that I had heard of, specifically <a href='http://dev/null'><abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr></a>, <a href='http://dev/null'>SCons</a>, <a href='http://dev/null'>C<abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr></a>, <a href='http://dev/null'>Jam</a>. I slowly came to the realization every build system designer since the creators of <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> (which arguably does it right) have been thinking about building software all wrong.</p><p>Understand that the entire purpose of a build system is to compile your complex piece of software <em>correctly every time</em>. Peter Miller discusses the importance of a correct build system in his paper <a href='http://aegis.sourceforge.net/auug97.pdf'>Recursive <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> Considered Harmful</a>. In order to build correctly always, the system must fully understand the <em>dependency tree</em> of the software. This dependency tree is, composed in part by any <code>#include</code> directives in your C files. For example, lets say we’re making a simple game, with a dependency tree like the following:</p><center> <embed class='graphviz' src='/images/graphviz/g-a544e5b2edc75c5a78c120ebcd7abc60.svg' type='image/svg+xml'/></center><p>This means that before <code>game.c</code> can be built, <code>common.h</code> and <code>player.h</code> must exist, and before <code>game.exe</code> can be built, <code>game.c</code> must exist. Additionally, <code>game.exe</code> can be said to <em>transitively depend</em> upon <code>common.h</code> and <code>player.h</code>.</p><p>Now, this works fine always because you wrote <code>common.h</code>, <code>player.h</code> and <code>game.c</code>, but lets say you were writing a game, and wanted to create a domain-specific language to express the levels. This <abbr title='Domain specific language'>DSL</abbr>’s compiler would output C code, which would then be used from within your code. This can be expressed like so:</p><center> <embed class='graphviz' src='/images/graphviz/g-ac07f3d732526cc0933b8a2d3919cf32.svg' type='image/svg+xml'/></center><p>The dependencies <code>common.h → levels.c</code> and <code>player.h → levels.c</code> is not detected in this case unless you explicitly write that dependency into your build system. That is undesirable however as doing so is fragile. What you really want, is to <em>dynamically</em> introduce dependencies into the build system. In other words, in order for a build system to be <em>correct</em>, it sometimes must be able to detect dependencies while it’s traversing the dependency tree it is detecting dependencies for!</p><p><abbr title='GNU Compiler Collection'>GCC</abbr> provides a facility for outputting a <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> compatible list of a file’s dependencies with the <code>-M</code> option. From <abbr title='GNU Compiler Collection'>GCC</abbr>’s <a href='http://gcc.gnu.org/onlinedocs/cpp/Invocation.html#index-M-141'>docs</a>:</p><pre><code>-M
	Instead of outputting the result of preprocessing, output a rule
	suitable for make describing the dependencies of the main source file.</code></pre><p>GNU <abbr title='A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.'>Make</abbr> has introduced the <code>include</code> extension that allows you to generate and include these files, albeit in a more limited fashion. From the <a href='http://www.gnu.org/software/make/manual/html_node/Remaking-Makefiles.html#Remaking-Makefiles'>include</a> directive’s documentation:</p><pre><code>After reading in all makefiles, make will consider each as a goal target and
attempt to update it. If a makefile has a rule which says how to update it
(found either in that very makefile or in another one) or if an implicit
rule applies to it (see Using Implicit Rules), it will be updated if
necessary. After all makefiles have been checked, if any have actually been
changed, make starts with a clean slate and reads all the makefiles over
again.</code></pre><p>This mechanism can be leveraged to create a limited solution to the <em>traversal-time dependency detection</em> problem, which our game suffered from. Unfortunately, this works only for a single “level” of traversal-time dependency detection. E.g. the following does not work:</p><center> <embed class='graphviz' src='/images/graphviz/g-53cf58ab57e6f3a1723ab97f8128d864.svg' type='image/svg+xml'/></center><p>I’ve built a functional build system for <abbr title='A single-player roguelike video game originally released in 1987.'>Nethack</abbr> which leverages these concepts. You can see an abbreviated dependency graph for Nethack <a href='/files/nethack-dependencies.pdf'>here</a>, and I also gave a presentation on the <abbr title='A single-player roguelike video game originally released in 1987.'>Nethack</abbr> build system which can be seen <a href='http://prezi.com/vzxavg014qlf/nethack-compilation/'>here</a>. The build system itself is hosted <a href='https://github.com/ComputerScienceHouse/bingehack'>here</a>.</p></div><div id="disqus"><div id="disqus_thread"></div> <script>var disqus_shortname="eatnumber1",disqus_identifier="/blog/2012-05-18/designing-robust-build-systems";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript> Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript"> comments powered by Disqus. </a> </noscript> <a href="http://disqus.com" class="dsq-brlink"> blog comments powered by <span class="logo-disqus">Disqus</span> </a></div><div id="footer"> <address> <span class="copyright"> Content by <a rel="author" href="/">Russell Harmon</a>. Design by <a href="http://mark.reid.name/info/site.html">Mark Reid</a> <br/> (<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>) </span> <span class="engine"> Powered by <a href="http://jekyllrb.com/" title="A static, minimalist CMS">Jekyll</a>. Hosted by <a href="http://pages.github.com/">GitHub</a>. </span> <address></div></div> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-10349264-2"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html>