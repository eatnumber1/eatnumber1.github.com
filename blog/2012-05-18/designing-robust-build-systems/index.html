<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>Designing Robust Build Systems ← Machinae Elegantiam</title><meta name="author" content="Russell Harmon"/><link rel="stylesheet" href="/css/reset.css" type="text/css"/><link rel="stylesheet" href="/css/screen.css" type="text/css"/><link rel="stylesheet" href="/css/960.css" type="text/css"/><link rel="stylesheet" href="/css/syntax.css" type="text/css"/><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Walter+Turncoat:regular"/><meta name="keywords" content="programming,build systems,make"/><meta name="description" content="A correct build system must be able to solve the problem of traversal-time dependency detection."/></head><body id=""><div id="site"><div id="header"><h1> <span class="nav"> <a href="/machinae" title="A programming blog">Machinae Elegantiam</a> <span class="byline">← <a href="/">Russell Harmon</a></span> </span></h1></div><div id="page"><p>A few years ago, I took a hard look at the current state of the art of build systems. The ones I looked at were the ones that I had heard of, specifically <a href="http://dev/null"><abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr></a>, <a href="http://dev/null">SCons</a>, <a href="http://dev/null">CMake</a>, <a href="http://dev/null">Jam</a>. I slowly came to the realization every build system designer since the creators of <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> (which arguably does it right) have been thinking about building software all wrong.</p><p>Understand that the entire purpose of a build system is to compile your complex piece of software <em>correctly every time</em>. Peter Miller discusses the importance of a correct build system in his paper <a href="http://aegis.sourceforge.net/auug97.pdf">Recursive <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> Considered Harmful</a>. In order to build correctly always, the system must fully understand the <em>dependency tree</em> of the software. This dependency tree is, composed in part by any <code>#include</code> directives in your C files. For example, lets say we’re making a simple game, with a dependency tree like the following:</p><center><div class="graphviz-wrapper"><svg role="img" aria-label="" width="408pt" height="98pt" viewbox="0.00 0.00 408.00 98.00"><title></title> <desc> digraph example1 { rankdir = "LR";common_h [label = "common.h"]; player_h [label = "player.h"]; game_c [label = "game.c"]; game_exe [label = "game.exe"];common_h -&gt; game_c; player_h -&gt; game_c; game_c -&gt; game_exe; } </desc><g id="graph1" class="graph" transform="scale(1 1) rotate(0) translate(4 94)"><title>example1</title> <polygon fill="white" stroke="white" points="-4,5 -4,-94 405,-94 405,5 -4,5"/><g id="node1" class="node"><title>common_h</title> <ellipse fill="none" stroke="black" cx="61" cy="-72" rx="61.1496" ry="18"/> <text text-anchor="middle" x="61" y="-67.9" font-family="Times Roman,serif" font-size="14.00">common.h</text> </g><g id="node3" class="node"><title>game_c</title> <ellipse fill="none" stroke="black" cx="203" cy="-45" rx="45.1673" ry="18"/> <text text-anchor="middle" x="203" y="-40.9" font-family="Times Roman,serif" font-size="14.00">game.c</text> </g><g id="edge2" class="edge"><title>common_h-&gt;game_c</title> <path fill="none" stroke="black" d="M112.667,-62.176C125.557,-59.7251 139.367,-57.0992 152.214,-54.6565"/> <polygon fill="black" stroke="black" points="153.104,-58.05 162.274,-52.7436 151.797,-51.1732 153.104,-58.05"/> </g><g id="node2" class="node"><title>player_h</title> <ellipse fill="none" stroke="black" cx="61" cy="-18" rx="48.8383" ry="18"/> <text text-anchor="middle" x="61" y="-13.9" font-family="Times Roman,serif" font-size="14.00">player.h</text> </g><g id="edge4" class="edge"><title>player_h-&gt;game_c</title> <path fill="none" stroke="black" d="M105.151,-26.395C120.111,-29.2395 136.936,-32.4386 152.361,-35.3714"/> <polygon fill="black" stroke="black" points="151.783,-38.8242 162.261,-37.2538 153.091,-31.9474 151.783,-38.8242"/> </g><g id="node4" class="node"><title>game_exe</title> <ellipse fill="none" stroke="black" cx="342" cy="-45" rx="57.1737" ry="18"/> <text text-anchor="middle" x="342" y="-40.9" font-family="Times Roman,serif" font-size="14.00">game.exe</text> </g><g id="edge6" class="edge"><title>game_c-&gt;game_exe</title> <path fill="none" stroke="black" d="M248.129,-45C256.538,-45 265.492,-45 274.404,-45"/> <polygon fill="black" stroke="black" points="274.418,-48.5001 284.418,-45 274.418,-41.5001 274.418,-48.5001"/> </g> </g> </svg></div></center><p>This means that before <code>game.c</code> can be built, <code>common.h</code> and <code>player.h</code> must exist, and before <code>game.exe</code> can be built, <code>game.c</code> must exist. Additionally, <code>game.exe</code> can be said to <em>transitively depend</em> upon <code>common.h</code> and <code>player.h</code>.</p><p>Now, this works fine always because you wrote <code>common.h</code>, <code>player.h</code> and <code>game.c</code>, but lets say you were writing a game, and wanted to create a domain-specific language to express the levels. This <abbr title="Domain specific language">DSL</abbr>’s compiler would output C code, which would then be used from within your code. This can be expressed like so:</p><center><div class="graphviz-wrapper"><svg role="img" aria-label="" width="360pt" height="332pt" viewbox="0.00 0.00 359.61 332.00"><title></title> <desc> digraph example2 { common_h [label = "common.h"]; player_h [label = "player.h"]; game_c [label = "game.c"]; game_exe [label = "game.exe"];levcomp_c [label = "level_compiler.c"]; levcomp [label = "level_compiler.exe"]; levels_c [label = "levels.c"];common_h -&gt; levcomp_c -&gt; levcomp -&gt; levels_c; player_h -&gt; levels_c [style = "dashed"]; common_h -&gt; levels_c [style = "dashed"]; levels_c -&gt; game_exe;common_h -&gt; game_c; player_h -&gt; game_c; game_c -&gt; game_exe; } </desc><g id="graph1" class="graph" transform="scale(1 1) rotate(0) translate(4 328)"><title>example2</title> <polygon fill="white" stroke="white" points="-4,5 -4,-328 356.614,-328 356.614,5 -4,5"/><g id="node1" class="node"><title>common_h</title> <ellipse fill="none" stroke="black" cx="228.629" cy="-306" rx="61.1496" ry="18"/> <text text-anchor="middle" x="228.629" y="-301.9" font-family="Times Roman,serif" font-size="14.00">common.h</text> </g><g id="node3" class="node"><title>game_c</title> <ellipse fill="none" stroke="black" cx="63.6286" cy="-90" rx="45.1673" ry="18"/> <text text-anchor="middle" x="63.6286" y="-85.9" font-family="Times Roman,serif" font-size="14.00">game.c</text> </g><g id="edge12" class="edge"><title>common_h-&gt;game_c</title> <path fill="none" stroke="black" d="M181.041,-294.443C127.553,-278.623 43.2819,-244.523 5.62861,-180 -2.43571,-166.181 -0.757193,-158.67 5.62861,-144 11.0879,-131.458 21.0548,-120.513 31.2047,-111.816"/> <polygon fill="black" stroke="black" points="33.6811,-114.318 39.3014,-105.336 29.307,-108.852 33.6811,-114.318"/> </g><g id="node5" class="node"><title>levcomp_c</title> <ellipse fill="none" stroke="black" cx="228.629" cy="-234" rx="86.1654" ry="18"/> <text text-anchor="middle" x="228.629" y="-229.9" font-family="Times Roman,serif" font-size="14.00">level_compiler.c</text> </g><g id="edge2" class="edge"><title>common_h-&gt;levcomp_c</title> <path fill="none" stroke="black" d="M228.629,-287.831C228.629,-280.131 228.629,-270.974 228.629,-262.417"/> <polygon fill="black" stroke="black" points="232.129,-262.413 228.629,-252.413 225.129,-262.413 232.129,-262.413"/> </g><g id="node7" class="node"><title>levels_c</title> <ellipse fill="none" stroke="black" cx="200.629" cy="-90" rx="46.0565" ry="18"/> <text text-anchor="middle" x="200.629" y="-85.9" font-family="Times Roman,serif" font-size="14.00">levels.c</text> </g><g id="edge8" class="edge"><title>common_h-&gt;levels_c</title> <path fill="none" stroke="black" stroke-dasharray="5,2" d="M269.058,-292.49C288.545,-283.915 310.487,-270.821 323.629,-252 351.277,-212.402 362.704,-183.992 335.629,-144 317.652,-117.448 284.278,-103.951 255.212,-97.0903"/> <polygon fill="black" stroke="black" points="255.655,-93.6057 245.143,-94.9298 254.187,-100.45 255.655,-93.6057"/> </g><g id="node2" class="node"><title>player_h</title> <ellipse fill="none" stroke="black" cx="63.6286" cy="-162" rx="48.8383" ry="18"/> <text text-anchor="middle" x="63.6286" y="-157.9" font-family="Times Roman,serif" font-size="14.00">player.h</text> </g><g id="edge14" class="edge"><title>player_h-&gt;game_c</title> <path fill="none" stroke="black" d="M63.6286,-143.831C63.6286,-136.131 63.6286,-126.974 63.6286,-118.417"/> <polygon fill="black" stroke="black" points="67.1287,-118.413 63.6286,-108.413 60.1287,-118.413 67.1287,-118.413"/> </g><g id="edge6" class="edge"><title>player_h-&gt;levels_c</title> <path fill="none" stroke="black" stroke-dasharray="5,2" d="M92.0151,-147.082C112.818,-136.149 141.243,-121.21 163.795,-109.358"/> <polygon fill="black" stroke="black" points="165.523,-112.403 172.747,-104.653 162.267,-106.207 165.523,-112.403"/> </g><g id="node4" class="node"><title>game_exe</title> <ellipse fill="none" stroke="black" cx="131.629" cy="-18" rx="57.1737" ry="18"/> <text text-anchor="middle" x="131.629" y="-13.9" font-family="Times Roman,serif" font-size="14.00">game.exe</text> </g><g id="edge16" class="edge"><title>game_c-&gt;game_exe</title> <path fill="none" stroke="black" d="M79.7437,-72.937C88.2564,-63.9235 98.8602,-52.6959 108.259,-42.7443"/> <polygon fill="black" stroke="black" points="110.835,-45.114 115.157,-35.4407 105.746,-40.3076 110.835,-45.114"/> </g><g id="node6" class="node"><title>levcomp</title> <ellipse fill="none" stroke="black" cx="228.629" cy="-162" rx="97.9784" ry="18"/> <text text-anchor="middle" x="228.629" y="-157.9" font-family="Times Roman,serif" font-size="14.00">level_compiler.exe</text> </g><g id="edge3" class="edge"><title>levcomp_c-&gt;levcomp</title> <path fill="none" stroke="black" d="M228.629,-215.831C228.629,-208.131 228.629,-198.974 228.629,-190.417"/> <polygon fill="black" stroke="black" points="232.129,-190.413 228.629,-180.413 225.129,-190.413 232.129,-190.413"/> </g><g id="edge4" class="edge"><title>levcomp-&gt;levels_c</title> <path fill="none" stroke="black" d="M221.563,-143.831C218.456,-135.841 214.738,-126.282 211.304,-117.451"/> <polygon fill="black" stroke="black" points="214.481,-115.965 207.595,-107.913 207.957,-118.502 214.481,-115.965"/> </g><g id="edge10" class="edge"><title>levels_c-&gt;game_exe</title> <path fill="none" stroke="black" d="M184.277,-72.937C175.639,-63.9235 164.879,-52.6959 155.342,-42.7443"/> <polygon fill="black" stroke="black" points="157.789,-40.2389 148.343,-35.4407 152.735,-45.0823 157.789,-40.2389"/> </g> </g> </svg></div></center><p>The dependencies <code>common.h → levels.c</code> and <code>player.h → levels.c</code> is not detected in this case unless you explicitly write that dependency into your build system. That is undesirable however as doing so is fragile. What you really want, is to <em>dynamically</em> introduce dependencies into the build system. In other words, in order for a build system to be <em>correct</em>, it sometimes must be able to detect dependencies while it’s traversing the dependency tree it is detecting dependencies for!</p><p><abbr title="GNU Compiler Collection">GCC</abbr> provides a facility for outputting a <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> compatible list of a file’s dependencies with the <code>-M</code> option. From <abbr title="GNU Compiler Collection">GCC</abbr>’s <a href="http://gcc.gnu.org/onlinedocs/cpp/Invocation.html#index-M-141">docs</a>:</p><pre><code>-M
	Instead of outputting the result of preprocessing, output a rule
	suitable for make describing the dependencies of the main source file.
</code></pre><p>GNU <abbr title="A utility that automatically builds executable programs and libraries from source code by reading files called makefiles which specify how to derive the target program.">Make</abbr> has introduced the <code>include</code> extension that allows you to generate and include these files, albeit in a more limited fashion. From the <a href="http://www.gnu.org/software/make/manual/html_node/Remaking-Makefiles.html#Remaking-Makefiles">include</a> directive’s documentation:</p><pre><code>After reading in all makefiles, make will consider each as a goal target and
attempt to update it. If a makefile has a rule which says how to update it
(found either in that very makefile or in another one) or if an implicit
rule applies to it (see Using Implicit Rules), it will be updated if
necessary. After all makefiles have been checked, if any have actually been
changed, make starts with a clean slate and reads all the makefiles over
again.
</code></pre><p>This mechanism can be leveraged to create a limited solution to the <em>traversal-time dependency detection</em> problem, which our game suffered from. Unfortunately, this works only for a single “level” of traversal-time dependency detection. E.g. the following does not work:</p><center><div class="graphviz-wrapper"><svg role="img" aria-label="" width="154pt" height="404pt" viewbox="0.00 0.00 154.00 404.00"><title></title> <desc> digraph example3 { //rankdir = "LR";a_c [label = "a.c"]; a_exe [label = "a.exe"]; b_c [label = "b.c"]; b_exe [label = "b.exe"];c_h [label = "c.h"]; c_c [label = "c.c"]; c_exe [label = "c.exe"];a_c -&gt; a_exe -&gt; b_c -&gt; b_exe -&gt; c_c -&gt; c_exe; c_h -&gt; c_c; } </desc><g id="graph1" class="graph" transform="scale(1 1) rotate(0) translate(4 400)"><title>example3</title> <polygon fill="white" stroke="white" points="-4,5 -4,-400 151,-400 151,5 -4,5"/><g id="node1" class="node"><title>a_c</title> <ellipse fill="none" stroke="black" cx="37" cy="-378" rx="27" ry="18"/> <text text-anchor="middle" x="37" y="-373.9" font-family="Times Roman,serif" font-size="14.00">a.c</text> </g><g id="node2" class="node"><title>a_exe</title> <ellipse fill="none" stroke="black" cx="37" cy="-306" rx="36.8288" ry="18"/> <text text-anchor="middle" x="37" y="-301.9" font-family="Times Roman,serif" font-size="14.00">a.exe</text> </g><g id="edge2" class="edge"><title>a_c-&gt;a_exe</title> <path fill="none" stroke="black" d="M37,-359.831C37,-352.131 37,-342.974 37,-334.417"/> <polygon fill="black" stroke="black" points="40.5001,-334.413 37,-324.413 33.5001,-334.413 40.5001,-334.413"/> </g><g id="node3" class="node"><title>b_c</title> <ellipse fill="none" stroke="black" cx="37" cy="-234" rx="27" ry="18"/> <text text-anchor="middle" x="37" y="-229.9" font-family="Times Roman,serif" font-size="14.00">b.c</text> </g><g id="edge3" class="edge"><title>a_exe-&gt;b_c</title> <path fill="none" stroke="black" d="M37,-287.831C37,-280.131 37,-270.974 37,-262.417"/> <polygon fill="black" stroke="black" points="40.5001,-262.413 37,-252.413 33.5001,-262.413 40.5001,-262.413"/> </g><g id="node4" class="node"><title>b_exe</title> <ellipse fill="none" stroke="black" cx="37" cy="-162" rx="36.8288" ry="18"/> <text text-anchor="middle" x="37" y="-157.9" font-family="Times Roman,serif" font-size="14.00">b.exe</text> </g><g id="edge4" class="edge"><title>b_c-&gt;b_exe</title> <path fill="none" stroke="black" d="M37,-215.831C37,-208.131 37,-198.974 37,-190.417"/> <polygon fill="black" stroke="black" points="40.5001,-190.413 37,-180.413 33.5001,-190.413 40.5001,-190.413"/> </g><g id="node6" class="node"><title>c_c</title> <ellipse fill="none" stroke="black" cx="78" cy="-90" rx="27" ry="18"/> <text text-anchor="middle" x="78" y="-85.9" font-family="Times Roman,serif" font-size="14.00">c.c</text> </g><g id="edge5" class="edge"><title>b_exe-&gt;c_c</title> <path fill="none" stroke="black" d="M46.925,-144.571C51.81,-135.992 57.7983,-125.476 63.2097,-115.973"/> <polygon fill="black" stroke="black" points="66.2595,-117.691 68.1664,-107.269 60.1766,-114.227 66.2595,-117.691"/> </g><g id="node5" class="node"><title>c_h</title> <ellipse fill="none" stroke="black" cx="119" cy="-162" rx="27" ry="18"/> <text text-anchor="middle" x="119" y="-157.9" font-family="Times Roman,serif" font-size="14.00">c.h</text> </g><g id="edge8" class="edge"><title>c_h-&gt;c_c</title> <path fill="none" stroke="black" d="M109.284,-144.937C104.331,-136.239 98.2039,-125.48 92.6887,-115.795"/> <polygon fill="black" stroke="black" points="95.6366,-113.898 87.6467,-106.941 89.5537,-117.362 95.6366,-113.898"/> </g><g id="node7" class="node"><title>c_exe</title> <ellipse fill="none" stroke="black" cx="78" cy="-18" rx="36.1339" ry="18"/> <text text-anchor="middle" x="78" y="-13.9" font-family="Times Roman,serif" font-size="14.00">c.exe</text> </g><g id="edge6" class="edge"><title>c_c-&gt;c_exe</title> <path fill="none" stroke="black" d="M78,-71.8314C78,-64.131 78,-54.9743 78,-46.4166"/> <polygon fill="black" stroke="black" points="81.5001,-46.4132 78,-36.4133 74.5001,-46.4133 81.5001,-46.4132"/> </g> </g> </svg></div></center><p>I’ve built a functional build system for <abbr title="A single-player roguelike video game originally released in 1987.">Nethack</abbr> which leverages these concepts. You can see an abbreviated dependency graph for <abbr title="A single-player roguelike video game originally released in 1987.">Nethack</abbr> <a href="/files/nethack-dependencies.pdf">here</a>, and I also gave a presentation on the <abbr title="A single-player roguelike video game originally released in 1987.">Nethack</abbr> build system which can be seen <a href="http://prezi.com/vzxavg014qlf/nethack-compilation/">here</a>. The build system itself is hosted <a href="https://github.com/ComputerScienceHouse/bingehack">here</a>.</p></div><div id="disqus"><div id="disqus_thread"></div> <script>var disqus_shortname="eatnumber1",disqus_identifier="/blog/2012-05-18/designing-robust-build-systems";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript> Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript"> comments powered by Disqus. </a> </noscript> <a href="http://disqus.com" class="dsq-brlink"> blog comments powered by <span class="logo-disqus">Disqus</span> </a></div><div id="footer"> <address> <span class="copyright"> Content by <a rel="author" href="/">Russell Harmon</a>. Design by <a href="http://mark.reid.name/info/site.html">Mark Reid</a> <br/> (<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>) </span> <span class="engine"> Powered by <a href="http://jekyllrb.com/" title="A static, minimalist CMS">Jekyll</a>. Hosted by <a href="http://pages.github.com/">GitHub</a>. </span> <address></div></div> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-10349264-2"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html>