<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>Function-like Macros are Hard ← Machinae Elegantiam</title><meta name="author" content="Russell Harmon"/><link rel="stylesheet" href="/css/reset.css" type="text/css"/><link rel="stylesheet" href="/css/screen.css" type="text/css"/><link rel="stylesheet" href="/css/960.css" type="text/css"/><link rel="stylesheet" href="/css/syntax.css" type="text/css"/><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Walter+Turncoat:regular"/><meta name="keywords" content="programming,c,preprocessor,cpp,macros"/><meta name="description" content="It's surprisingly difficult to make a proper function-like macro."/></head><body id=""><div id="site"><div id="header"><h1> <span class="nav"> <a href="/machinae" title="A programming blog">Machinae Elegantiam</a> <span class="byline">← <a href="/">Russell Harmon</a></span> </span></h1></div><div id="page"><h1 id="function-like-macros-are-hard">Function-like Macros are Hard</h1><p>It’s surprisingly difficult to make a proper function-like macro. You’d think that it’s as simple as putting your code all on one line in the macro’s body, but there’s a great deal of considerations that may not have occurred to you, and in the end it’s not even possible to do in the general case without relying on non-standard extensions to C.</p><h1 id="the-min-macro-challenge">The MIN Macro Challenge</h1><p>An old challenge that I’ve heard used to illustrate these difficulties goes as follows:</p><blockquote><p>Write a function-like macro for finding the smaller of two numbers.</p></blockquote><p>In other words, a <code>min</code> macro!</p><h2 id="attempt-1-if-statements">Attempt 1: If Statements</h2><p>Taking on the challenge, my first attempt goes as follows:</p><div class="highlight"><pre><code class="c"><span class="cp">#define min(a, b, out) \</span>
<span class="cp">	if (a &lt; b) { \</span>
<span class="cp">		out = a; \</span>
<span class="cp">	} else { \</span>
<span class="cp">		out = b; \</span>
<span class="cp">	}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span></code></pre></div><p>This uses a simple if statement to solve the problem and works in the example given, but doesn’t even compile in the following case:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="p">),</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>This code uses the <a href="http://en.wikipedia.org/wiki/Comma_operator" title="Comma Operator">comma operator</a> in order to have the return value of the entire <a href="http://lambda-the-ultimate.org/node/1044" title="Expressions vs Statements">expression</a> be the value of the output variable.</p><p>This doesn’t work however because the min macro expands into an if-statement. Here’s the preprocessed code:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">},</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><h2 id="attempt-2-ternary-operation">Attempt 2: Ternary Operation</h2><p>Trying again, my second attempt goes as follows:</p><div class="highlight"><pre><code class="c"><span class="cp">#define min(a, b) a &gt; b ? b : a</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>This uses a <a href="http://en.wikipedia.org/wiki/%3F:" title="Ternary Operation">ternary operation</a> to make the macro into an expression rather than a statement like attempt 1 was, but doesn’t work correctly for the following program:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></div><p>Just looking at the code, it seems as though this program should return <code>4</code>, but instead it returns <code>2</code>! Again what happened becomes apparent when we preprocess the code:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></div><p>Our <code>+ 2</code> got associated with the else branch of the ternary operation, and so not executed! We can fix this by surrounding the entire macro result in parentheses.</p><h2 id="attempt-3-parenthesized-ternary-operation">Attempt 3: Parenthesized Ternary Operation</h2><p>Trying again, my third attempt goes as follows:</p><div class="highlight"><pre><code class="c"><span class="cp">#define min(a, b) (a &gt; b ? b : a)</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></code></pre></div><p>This surrounds the entire macro in parentheses in order to make the ternary operation evaluate before any additional expressions that are placed around it. Unfortunately, this too breaks for the following program:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>Since <code>3 &amp; 0</code> is zero, you would expect this to return <code>0</code>, but instead returns <code>2</code>. Here’s the preprocessed source:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">&amp;</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>Since the <code>&amp;</code> operator has a lower <a href="http://en.wikipedia.org/wiki/Operators_in_C_and_C%2B%2B#Operator_precedence" title="C Operator Precedence">precedence</a> than <code>&gt;</code>, the expression is equivalent to <code>(2 &gt; 3) &amp; 0</code>, which is always false! We can fix this by surrounding every use of a macro argument with parentheses.</p><h2 id="attempt-4-parenthesized-ternary-operation-with-parenthesized-arguments">Attempt 4: Parenthesized Ternary Operation with Parenthesized Arguments</h2><p>Trying again, my fourth attempt goes as follows:</p><div class="highlight"><pre><code class="c"><span class="cp">#define min(a, b) ((a) &gt; (b) ? (b) : (a))</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>This surrounds every use of a macro argument with parentheses in order to force the argument to evaluate before any additional expressions that are placed around it. Unfortunately (is this getting tiring yet?), this too breaks for the following program:<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup></p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>When run, this program prints <code>1</code> twice! Lets see the preprocessed code:</p><div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
<span class="p">}</span></code></pre></div><p>It’s getting pretty ugly now, but this code ends up calling <code>printf</code> twice if the first call to it returned a number less than <code>3</code>.</p><h2 id="attempt-5-statement-expressions">Attempt 5: Statement Expressions</h2><p>Now we’re in a bit of a difficult spot. The only way to prevent this case is to create temporary variables in which to store the result of expanding the macro arguments, but creating temporary variables will cause this macro to no longer be an expression, bringing us back to the same problems with attempt 1. If you’re writing strictly standards conforming C, this is where you stop. This is an unsolvable problem. If instead however we can draw from the extensions to C that <a href="https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html" title="Extensions to the C Language Family">GNUC</a> brings us, we can leverage <a href="https://gcc.gnu.org/onlinedocs/gcc/Statement-Exprs.html#Statement-Exprs" title="Statements and Declarations in Expressions">statement expressions</a>. A statement expression is an expression which may itself contain statements and declarations, enabling us to create our temporary variables. The syntax for statement expressions is a little odd. You use it by surrounding your code with <code>({ })</code>, and the last statement in your statement expression should itself be an expression and that expression will be the resulting value of the entire statement expression. This enables us to write a better <code>min</code>:</p><div class="highlight"><pre><code class="c"><span class="cp">#define min(a, b) ({ \</span>
<span class="cp">	int _a = (a); \</span>
<span class="cp">	int _b = (b); \</span>
<span class="cp">	_a &lt; _b ? _a : _b; \</span>
<span class="cp">})</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>But wait, there’s a problem here. I’ve built in the assumption that <code>a</code> and <code>b</code> have type <code>int</code>, where previously we had made no such assumption. Thankfully we can generalize the macro again using another GNUC extension: <a href="https://gcc.gnu.org/onlinedocs/gcc/Typeof.html#Typeof" title="Typeof">typeof</a>. This extension to C allows you to refer to the type of an arbitrary expression, thereby allowing you to declare variables of the type of an arbitrary expression.</p><div class="highlight"><pre><code class="c"><span class="cp">#define min(a, b) ({ \</span>
<span class="cp">	typeof(a) _a = (a); \</span>
<span class="cp">	typeof(b) _b = (b); \</span>
<span class="cp">	_a &lt; _b ? _a : _b; \</span>
<span class="cp">})</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span></code></pre></div><p>And now we’ve finally arrived at a generalized function-like min macro that can be used anywhere that a normal function can (but you still can’t take the address of it).</p><div class="footnotes"><ol><li id="fn:1"><p>Note that <code>printf</code> returns the number of characters printed. <a href="#fnref:1" class="reversefootnote">↩</a></p></li></ol></div></div><div id="disqus"><div id="disqus_thread"></div> <script>var disqus_shortname="eatnumber1",disqus_identifier="/blog/2014-06-15/function-like-macros-are-hard";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript> Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript"> comments powered by Disqus. </a> </noscript> <a href="http://disqus.com" class="dsq-brlink"> blog comments powered by <span class="logo-disqus">Disqus</span> </a></div><div id="footer"> <address> <span class="copyright"> Content by <a rel="author" href="/">Russell Harmon</a>. Design by <a href="http://mark.reid.name/info/site.html">Mark Reid</a> <br/> (<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>) </span> <span class="engine"> Powered by <a href="http://jekyllrb.com/" title="A static, minimalist CMS">Jekyll</a>. Hosted by <a href="http://pages.github.com/">GitHub</a>. </span> <address></div></div> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-10349264-2"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html>